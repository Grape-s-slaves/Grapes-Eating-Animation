name: Build and Release

on:
  push:
    branches: [ master ]
    tags: [ 'v*' ]

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.version_check.outputs.should_build }}
      current_version: ${{ steps.version_check.outputs.current_version }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check version changes
      id: version_check
      run: |
        # Extract current version from mods.toml
        if [ -f "src/main/resources/META-INF/mods.toml" ]; then
          CURRENT_VERSION=$(grep -E '^version\s*=' src/main/resources/META-INF/mods.toml | sed -E 's/^version\s*=\s*"([^"]+)".*/\1/')
        else
          echo "mods.toml not found, checking build.gradle"
          CURRENT_VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}' 2>/dev/null || echo "1.0.0")
        fi
        
        echo "Current version: $CURRENT_VERSION"
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        
        # Check if this is a tag push (always build for tags)
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "Tag push detected, building release"
          echo "should_build=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Get the latest release version from GitHub
        LATEST_RELEASE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
          jq -r '.tag_name // "v0.0.0"' | sed 's/^v//')
          
        echo "Latest release version: $LATEST_RELEASE"
        
        # Compare versions
        if [ "$CURRENT_VERSION" != "$LATEST_RELEASE" ]; then
          echo "Version changed from $LATEST_RELEASE to $CURRENT_VERSION"
          echo "should_build=true" >> $GITHUB_OUTPUT
        else
          echo "Version unchanged ($CURRENT_VERSION), skipping build"
          echo "should_build=false" >> $GITHUB_OUTPUT
        fi

  build:
    needs: check-version
    runs-on: ubuntu-latest
    if: needs.check-version.outputs.should_build == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4  # Updated from v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Make gradlew executable
      run: chmod +x ./gradlew
      
    - name: Build with Gradle
      run: ./gradlew build
      
    - name: Test mod
      run: ./gradlew test
      
    - name: Get mod version
      id: version
      run: |
        # Use the version from the check job
        VERSION="${{ needs.check-version.outputs.current_version }}"
        echo "mod_version=$VERSION" >> $GITHUB_OUTPUT
        echo "Using version: $VERSION"
        
    - name: Get mod name
      id: modname
      run: |
        MOD_NAME=$(./gradlew properties -q | grep "^archivesBaseName:" | awk '{print $2}' || echo "gea")
        echo "mod_name=$MOD_NAME" >> $GITHUB_OUTPUT
        echo "Detected mod name: $MOD_NAME"
        
    - name: Find JAR file
      id: jar
      run: |
        JAR_PATH=$(find build/libs -name "*.jar" -not -name "*-sources.jar" -not -name "*-dev.jar" | head -1)
        JAR_NAME=$(basename "$JAR_PATH")
        echo "jar_path=$JAR_PATH" >> $GITHUB_OUTPUT
        echo "jar_name=$JAR_NAME" >> $GITHUB_OUTPUT
        echo "Found JAR: $JAR_PATH"
        
    - name: Create Release Tag
      id: tag
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          TAG_NAME=${GITHUB_REF#refs/tags/}
        else
          TAG_NAME="v${{ steps.version.outputs.mod_version }}-$(date +'%Y%m%d-%H%M%S')"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag $TAG_NAME
          git push origin $TAG_NAME
        fi
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "Release tag: $TAG_NAME"
      env:
        GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        
    - name: Generate changelog
      id: changelog
      run: |
        CHANGELOG=$(git log --oneline --pretty=format:"- %s" -10 | head -20)
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v2  # Updated from v1
      with:
        tag_name: ${{ steps.tag.outputs.tag_name }}
        name: "${{ steps.modname.outputs.mod_name }} v${{ steps.version.outputs.mod_version }}"
        body: |
          ## üçá Grapes Eating Animation v${{ steps.version.outputs.mod_version }}
          
          **Minecraft Version:** 1.20.1  
          **Forge Version:** 47.2.0  
          
          ### üì• Installation
          1. Install Minecraft Forge 47.2.0 or later
          2. Download the JAR file below
          3. Place it in your `mods` folder
          4. Launch Minecraft!
          
          ### üîÑ Recent Changes
          ${{ steps.changelog.outputs.changelog }}
          
          ### üìÅ Files
          - **${{ steps.jar.outputs.jar_name }}** - Main mod file for Minecraft 1.20.1
          
          ---
          *Built automatically from commit ${{ github.sha }}*
        files: |
          ${{ steps.jar.outputs.jar_path }}
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4  # Updated from v3
      with:
        name: mod-jar
        path: ${{ steps.jar.outputs.jar_path }}
        retention-days: 30

  skip-notification:
    needs: check-version
    runs-on: ubuntu-latest
    if: needs.check-version.outputs.should_build == 'false'
    
    steps:
    - name: Skip build notification
      run: |
        echo "üö´ Build skipped - Version unchanged"
        echo "Current version: ${{ needs.check-version.outputs.current_version }}"
        echo "No new release will be created."
